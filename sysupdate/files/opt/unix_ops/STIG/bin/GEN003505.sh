#!/bin/bash -x


. /etc/default/SYSconstants || exit 4

mkdir -p /var/core
chown -R root:root /var/core  ##GEN003502  ##GEN003503
chmod -R 0700 /var/core  ##GEN003504
chmod 600 /var/cache/abrt-di/*
chown root:root /var/cache/abrt-di/*
chmod 640 /var/spool/abrt/abrt-db  
chown root:root /var/spool/abrt/abrt-db
chmod 600 /var/spool/abrt/last-ccpp  
chown root:root /var/spool/abrt/last-ccpp
chmod 770 /var/cache/abrt-di  
chown abrt:abrt /var/cache/abrt-di
chmod 600 /var/cache/abrt-di/*
chown root:root /var/cache/abrt-di/*
chmod 750 /var/spool/abrt  
chown abrt:abrt /var/spool/abrt
chmod 750 /var/spool/abrt/*
chown -R abrt:root /var/spool/abrt/*
chmod 640 /var/spool/abrt/*/*
chmod 600 /var/spool/abrt/last-ccpp  
chown root:root /var/spool/abrt/last-ccpp
chmod 644 /var/spool/abrt/abrt-db  
chown root:root /var/spool/abrt/abrt-db
chmod 700 /var/spool/abrt-upload  
chown abrt:abrt /var/spool/abrt-upload


test "X${__OSNAME}" = "XSunOS" && {
/usr/sbin/svcadm -v enable -s svc:/system/coreadm:default


echo '#
# coreadm.conf
#
# Parameters for system core file configuration.
# Do NOT edit this file by hand -- use coreadm(1) instead.
#
COREADM_GLOB_PATTERN=/var/core/core.%f.%p.%n.%t
COREADM_GLOB_CONTENT=all
COREADM_INIT_PATTERN=core
COREADM_INIT_CONTENT=default
COREADM_GLOB_ENABLED=yes
COREADM_PROC_ENABLED=no
COREADM_GLOB_SETID_ENABLED=no
COREADM_PROC_SETID_ENABLED=no
COREADM_GLOB_LOG_ENABLED=yes' > /etc/coreadm.conf  ##GEN003501

/usr/bin/coreadm -u
}



FIX="${*}"
test "X${FIX}" = "X" && FIX='/var/core /var/*/abrt*/* /var/*/abrt*' 

sleep 1
TSTAMP=`perl -e 'print int(time)'`
SELF=`basename $0`
test "X${FIX}" != "X" && EXIST=`find ${FIX} 2>/dev/null|grep -v socket`

test "X${SELF}" != "X" -a "X${TSTAMP}" != "X" -a "X${EXIST}" != "X" && {
  chmod o-rwx ${EXIST} 
  test "X${__OSNAME}" = "XSunOS" && chmod A- ${EXIST}  ##GEN003505
  test "X${__OSNAME}" != "XSunOS" && setfacl --remove-all ${EXIST}  ##GEN003505
}


test "X${__OSNAME}" != "XSunOS" && {
  /sbin/chkconfig --level 345 abrtd on  ##RHEL-06-000261 ##we have buggy programs, need core files
  /sbin/service abrtd start  ##RHEL-06-000261 ##we have buggy programs, need core files
  /sbin/chkconfig --level 345 abrt-oops on
  /sbin/chkconfig --level 345 abrt-ccpp on
  /sbin/service abrt-oops start
  /sbin/service abrt-ccpp start


  grep "^|"  /proc/sys/kernel/core_pattern || {
    echo '/var/core/core.%e.%p.%h.%t' > /proc/sys/kernel/core_pattern  ##GEN003501

    FIX='/etc/sysctl.conf'
    sleep 1
    TSTAMP=`perl -e 'print int(time)'`
    SELF=`basename $0`
    MISSINGRULES=''
    COREPATTERN="kernel.core_pattern = /var/core/core.%e.%p.%h.%t"
    
    
    test "X${SELF}" = "X" -o "X${TSTAMP}" = "X" -o "X${FIX}" = "X" && exit
    
    grep "^kernel.core_pattern[\ ].*=[\ ].*/var/core/core.%e.%p.%h.%t$" ${FIX} >/dev/null
    if [ "X${?}" = "X0" ] ; then
      echo "already has ${COREPATTERN}"
    else
      MISSINGRULES="${MISSINGRULES}
${COREPATTERN}"
    fi  

    MISSINGRULES=`echo "${MISSINGRULES}"|grep '.'`
    if [ "X${MISSINGRULES}" != "X" ] ; then
      cp ${FIX} ${FIX}.pre${SELF}.${TSTAMP}
      grep -v  "^kernel.core_pattern[\ ].*" ${FIX}.pre${SELF}.${TSTAMP} > ${FIX}
      echo "${MISSINGRULES}" >> ${FIX}  
      diff -u ${FIX}.pre${SELF}.${TSTAMP} ${FIX}
      diff -u ${FIX}.pre${SELF}.${TSTAMP} ${FIX} > ${FIX}.${SELF}.${TSTAMP}.patch
    fi
  }
sysctl -p 
}


